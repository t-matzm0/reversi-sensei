name: Claude Auto Fix

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  auto-fix:
    if: github.event.label.name == 'claude-fix'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create branch name
        id: branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.issue.number }}"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create fix branch
        run: |
          git checkout -b ${{ steps.branch.outputs.name }}

      - name: Run Claude Code to fix issue
        id: claude-fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Install Claude Code CLI
          npm install -g @anthropic-ai/claude-code

          # Create prompt from issue
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          # Run Claude Code with the issue context
          claude -p "ä»¥ä¸‹ã®GitHub Issueã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚ä¿®æ­£å¾Œã€å¤‰æ›´å†…å®¹ã®æ¦‚è¦ã‚’èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚

          ## Issue #${{ github.event.issue.number }}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          ---
          æ³¨æ„äº‹é …:
          - æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          - ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆESLintã€Prettierï¼‰ã«å¾“ã£ã¦ãã ã•ã„
          - å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„" --output-format stream-json 2>&1 | tee claude-output.log || true

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Run quality checks
        if: steps.claude-fix.outputs.has_changes == 'true'
        run: |
          npm run lint -- --fix || true
          npm run format || true
          npm run type-check || true
          npm run test || true

      - name: Commit changes
        if: steps.claude-fix.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "fix: resolve issue #${{ github.event.issue.number }}

          ${{ github.event.issue.title }}

          Auto-generated by Claude Code
          Closes #${{ github.event.issue.number }}" || echo "No changes to commit"

      - name: Push changes
        if: steps.claude-fix.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.name }}

      - name: Create Pull Request
        if: steps.claude-fix.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix: ${context.payload.issue.title}`,
              body: `## æ¦‚è¦

            Issue #${context.payload.issue.number} ã®è‡ªå‹•ä¿®æ­£PRã§ã™ã€‚

            ## é–¢é€£Issue

            Closes #${context.payload.issue.number}

            ## å¤‰æ›´å†…å®¹

            Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
            è©³ç´°ã¯ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

            - [x] Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
            - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
            - [ ] å‹•ä½œç¢ºèª

            ---
            *ã“ã®PRã¯Claude Codeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`,
              head: `fix/issue-${context.payload.issue.number}`,
              base: 'develop'
            });

            // Add labels to PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['auto-generated', 'needs-review']
            });

            // Comment on the original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸ¤– Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£PRã‚’ä½œæˆã—ã¾ã—ãŸ: #${pr.number}\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
            });

      - name: Comment on failure
        if: failure() || steps.claude-fix.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âš ï¸ Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

            è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :
            - Issueã®å†…å®¹ãŒä¸æ˜Žç¢º
            - ä¿®æ­£ãŒè¤‡é›‘ã§è‡ªå‹•åŒ–ãŒå›°é›£
            - æŠ€è¡“çš„ãªå•é¡Œ

            æ‰‹å‹•ã§ã®å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
            });

            // Remove the claude-fix label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'claude-fix'
            }).catch(() => {});
