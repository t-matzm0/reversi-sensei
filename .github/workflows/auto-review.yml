name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  code-review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: Run quality checks
        id: quality
        run: |
          echo "## Quality Check Results" > quality-report.md
          echo "" >> quality-report.md

          # ESLint
          echo "### ESLint" >> quality-report.md
          if npm run lint 2>&1 | tee lint-output.txt; then
            echo "âœ… No ESLint errors" >> quality-report.md
            echo "lint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ESLint errors found:" >> quality-report.md
            echo '```' >> quality-report.md
            cat lint-output.txt >> quality-report.md
            echo '```' >> quality-report.md
            echo "lint_passed=false" >> $GITHUB_OUTPUT
          fi
          echo "" >> quality-report.md

          # TypeScript
          echo "### TypeScript" >> quality-report.md
          if npm run type-check 2>&1 | tee type-output.txt; then
            echo "âœ… No type errors" >> quality-report.md
            echo "type_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Type errors found:" >> quality-report.md
            echo '```' >> quality-report.md
            cat type-output.txt >> quality-report.md
            echo '```' >> quality-report.md
            echo "type_passed=false" >> $GITHUB_OUTPUT
          fi
          echo "" >> quality-report.md

          # Tests
          echo "### Tests" >> quality-report.md
          if npm test 2>&1 | tee test-output.txt; then
            echo "âœ… All tests passed" >> quality-report.md
            echo "test_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Some tests failed:" >> quality-report.md
            echo '```' >> quality-report.md
            tail -50 test-output.txt >> quality-report.md
            echo '```' >> quality-report.md
            echo "test_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Install Claude Code CLI
          npm install -g @anthropic-ai/claude-code || true

          # Get the diff
          git diff origin/${{ github.base_ref }}...HEAD -- ${{ steps.changed-files.outputs.all_changed_files }} > changes.diff

          if [ -s changes.diff ]; then
            # Run Claude Code review
            claude -p "ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          1. **ãƒã‚°ã®å¯èƒ½æ€§**: ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è¦‹è½ã¨ã—
          2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: XSSã€ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€æ©Ÿå¯†æƒ…å ±ã®éœ²å‡º
          3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: éžåŠ¹çŽ‡ãªå‡¦ç†ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
          4. **å¯èª­æ€§**: ã‚³ãƒ¼ãƒ‰ã®æ˜Žç¢ºã•ã€å‘½åè¦å‰‡
          5. **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**: React/Next.js/TypeScriptã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

          ## å‡ºåŠ›å½¢å¼
          - é‡è¦åº¦: ðŸ”´ Critical / ðŸŸ¡ Warning / ðŸ”µ Info
          - å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®ç®‡æ‰€ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜
          - æ”¹å–„æ¡ˆã‚’æç¤º

          ## å¤‰æ›´å·®åˆ†
          \`\`\`diff
          $(cat changes.diff)
          \`\`\`" --output-format text > claude-review.md 2>&1 || echo "Claude review failed" > claude-review.md
          else
            echo "No code changes to review" > claude-review.md
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let qualityReport = '';
            let claudeReview = '';

            try {
              qualityReport = fs.readFileSync('quality-report.md', 'utf8');
            } catch (e) {
              qualityReport = 'Quality report not available';
            }

            try {
              claudeReview = fs.readFileSync('claude-review.md', 'utf8');
            } catch (e) {
              claudeReview = 'Claude review not available';
            }

            const body = `## ðŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ${qualityReport}

            ---

            ### AI Code Review

            ${claudeReview}

            ---
            *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯GitHub Actionsã¨Claude Codeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ðŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }

      - name: Add review labels
        uses: actions/github-script@v7
        with:
          script: |
            const lintPassed = '${{ steps.quality.outputs.lint_passed }}' === 'true';
            const typePassed = '${{ steps.quality.outputs.type_passed }}' === 'true';
            const testPassed = '${{ steps.quality.outputs.test_passed }}' === 'true';

            const labels = [];

            if (lintPassed && typePassed && testPassed) {
              labels.push('quality-passed');
            } else {
              labels.push('needs-fixes');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels
              });
            }
