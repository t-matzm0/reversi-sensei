name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')

    steps:
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;

            if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'check_suite') {
              // Get PRs associated with this check suite
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.check_suite.head_branch}`
              });
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            }

            if (!prNumber) {
              core.setOutput('should_merge', 'false');
              return;
            }

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check if PR has auto-merge label
            const hasAutoMergeLabel = pr.labels.some(l => l.name === 'auto-merge');
            const hasApprovedLabel = pr.labels.some(l => l.name === 'approved');

            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const hasApproval = reviews.some(r => r.state === 'APPROVED');

            // Check CI status
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const allChecksPassed = checks.check_runs.every(
              check => check.conclusion === 'success' || check.conclusion === 'skipped' || check.name === 'auto-merge'
            );

            const shouldMerge = (hasAutoMergeLabel || hasApprovedLabel) && hasApproval && allChecksPassed;

            core.setOutput('pr_number', prNumber);
            core.setOutput('should_merge', shouldMerge.toString());
            core.setOutput('pr_title', pr.title);
            core.setOutput('base_branch', pr.base.ref);

      - name: Enable auto-merge
        if: steps.pr-info.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-info.outputs.pr_number }};

            try {
              // Merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });

              // Add merged label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['merged']
              });

              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'ğŸ‰ ã“ã®PRã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼'
              });

              console.log(`PR #${prNumber} merged successfully`);
            } catch (error) {
              console.error(`Failed to merge PR #${prNumber}:`, error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\næ‰‹å‹•ã§ã®ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
              });
            }
